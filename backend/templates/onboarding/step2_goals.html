<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Onboarding - Step 2</title>
  </head>
  <body>
    <h1>What are your top financial goals?</h1>

    <form id="form">
      <label><input type="checkbox" name="goal" value="PAY_OFF_DEBT" /> Pay off debt</label><br />
      <label><input type="checkbox" name="goal" value="GROW_SAVINGS" /> Grow savings</label><br />
      <label><input type="checkbox" name="goal" value="START_INVESTING" /> Begin investing</label><br />
      <label><input type="checkbox" name="goal" value="REDUCE_SPENDING" /> Reduce spending</label><br />
      <label><input type="checkbox" name="goal" value="STAY_ORGANIZED" /> Stay on top of finances</label><br /><br />

      <p id="error" style="color: red; display: none;"></p>

      <button type="button" id="backBtn">Back</button>
      <button type="submit">Continue</button>
    </form>

    <script>
      document.getElementById("backBtn").addEventListener("click", () => {
        window.location.href = "/app/onboarding/1/";
      });

      document.getElementById("form").addEventListener("submit", async (e) => {
        e.preventDefault();

        const goals = Array.from(document.querySelectorAll('input[name="goal"]:checked')).map(
          (el) => el.value
        );

        const errorEl = document.getElementById("error");
        errorEl.style.display = "none";
        errorEl.textContent = "";

        // client-side guard (matches backend requirement)
        if (goals.length === 0) {
          errorEl.textContent = "Please select at least one goal to continue.";
          errorEl.style.display = "block";
          return;
        }

        const res = await fetch("/api/users/onboarding/save", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ financial_goals: goals }),
        });

        if (!res.ok) {
          let payload = null;
          try {
            payload = await res.json();
          } catch {}
          if (res.status === 400 && payload?.error === "financial_goals_required") {
            errorEl.textContent = "Please select at least one goal to continue.";
            errorEl.style.display = "block";
            return;
          }
          alert("Failed to save. Try again.");
          return;
        }

        window.location.href = "/app/onboarding/3/";
      });
    </script>
  </body>
</html>